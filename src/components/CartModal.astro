---
const whatsappNumber = "573236588465";
---

<div
    id="cart-modal"
    class="hidden fixed inset-0 z-60 items-center justify-center bg-black/80 backdrop-blur-sm p-4"
>
    <div class="bg-bg-card rounded-card border border-border-subtle max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
        <div class="flex items-center justify-between p-6 border-b border-border-subtle">
            <div>
                <h2 class="text-2xl font-display font-bold text-white uppercase tracking-wide">Tu Pedido</h2>
                <p class="text-gray-400 text-sm mt-1">Revisa tu carrito antes de ordenar</p>
            </div>
            <button
                id="close-cart-modal"
                class="size-10 rounded-full bg-border-subtle hover:bg-white hover:text-bg-main text-white flex items-center justify-center transition-all active:scale-95"
                aria-label="Cerrar carrito"
            >
                <span class="material-symbols-outlined text-xl">close</span>
            </button>
        </div>

        <div id="cart-items-container" class="flex-1 overflow-y-auto p-6">
        </div>

        <div class="border-t border-border-subtle p-6 bg-bg-main">
            <div class="flex items-center justify-between mb-4">
                <span class="text-gray-400 font-display font-bold uppercase text-sm tracking-wider">Total</span>
                <span id="cart-total" class="text-2xl font-display font-bold text-primary">$0</span>
            </div>
            
            <div class="flex gap-3">
                <button
                    id="clear-cart-btn"
                    class="flex-1 py-3 rounded-btn bg-border-subtle hover:bg-red-600 text-white font-display font-bold uppercase tracking-wider text-sm transition-all active:scale-95 flex items-center justify-center gap-2"
                >
                    <span class="material-symbols-outlined text-[20px]">delete</span>
                    Vaciar
                </button>
                <a
                    id="send-whatsapp-btn"
                    href="#"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="flex-2 py-3 rounded-btn bg-[#25D366] hover:bg-[#20BA5A] text-white font-display font-bold uppercase tracking-wider text-sm transition-all active:scale-95 flex items-center justify-center gap-2 shadow-lg hover:shadow-[0_0_20px_rgba(37,211,102,0.4)]"
                >
                    <span class="material-symbols-outlined text-[20px]">send</span>
                    Enviar Pedido
                </a>
            </div>
        </div>
    </div>
</div>

<script>
  import { getCart, getCartTotal, updateQuantity, removeFromCart, clearCart, onCartUpdate, formatCartForWhatsApp } from '../utils/cartStore';
  import { formatPrice } from '../data/menu';
  
  const whatsappNumber = "573236588465";
  
  function renderCartItems() {
    const container = document.getElementById('cart-items-container');
    const totalElement = document.getElementById('cart-total');
    const sendButton = document.getElementById('send-whatsapp-btn') as HTMLAnchorElement;
    
    if (!container || !totalElement || !sendButton) return;
    
    const cart = getCart();
    const total = getCartTotal();
    
    totalElement.textContent = formatPrice(total);
    
    const message = formatCartForWhatsApp();
    sendButton.href = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    
    if (cart.length === 0) {
      container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <span class="material-symbols-outlined text-6xl text-gray-600 mb-4">shopping_cart</span>
          <p class="text-gray-400 text-lg font-display font-bold mb-2">Tu carrito está vacío</p>
          <p class="text-gray-500 text-sm">Agrega productos del menú para hacer tu pedido</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = cart.map(item => `
      <div class="flex items-center gap-4 p-4 bg-bg-main rounded-lg mb-3 border border-border-subtle hover:border-primary/30 transition-colors">
        <div class="flex-1">
          <h3 class="text-white font-display font-bold text-base mb-1">${item.name}</h3>
          <p class="text-gray-400 text-sm">${formatPrice(item.price)} c/u</p>
        </div>
        
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 bg-bg-card border border-border-subtle rounded-lg">
            <button
              class="quantity-decrease size-8 flex items-center justify-center text-white hover:text-primary transition-colors"
              data-name="${item.name}"
            >
              <span class="material-symbols-outlined text-[20px]">remove</span>
            </button>
            <span class="text-white font-bold min-w-[2ch] text-center">${item.quantity}</span>
            <button
              class="quantity-increase size-8 flex items-center justify-center text-white hover:text-primary transition-colors"
              data-name="${item.name}"
            >
              <span class="material-symbols-outlined text-[20px]">add</span>
            </button>
          </div>
          
          <div class="text-right min-w-[80px]">
            <p class="text-primary font-display font-bold text-lg">${formatPrice(item.price * item.quantity)}</p>
          </div>
          
          <button
            class="remove-item size-8 flex items-center justify-center text-gray-400 hover:text-red-500 transition-colors"
            data-name="${item.name}"
          >
            <span class="material-symbols-outlined text-[20px]">delete</span>
          </button>
        </div>
      </div>
    `).join('');
    
    attachCartItemListeners();
  }
  
  function attachCartItemListeners() {
    document.querySelectorAll('.quantity-decrease').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-name');
        if (name) {
          const cart = getCart();
          const item = cart.find(i => i.name === name);
          if (item) {
            updateQuantity(name, item.quantity - 1);
          }
        }
      });
    });
    
    document.querySelectorAll('.quantity-increase').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-name');
        if (name) {
          const cart = getCart();
          const item = cart.find(i => i.name === name);
          if (item) {
            updateQuantity(name, item.quantity + 1);
          }
        }
      });
    });
    
    document.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-name');
        if (name) {
          removeFromCart(name);
        }
      });
    });
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    renderCartItems();
    
    onCartUpdate(() => {
      renderCartItems();
    });
    
    const closeBtn = document.getElementById('close-cart-modal');
    const modal = document.getElementById('cart-modal');
    
    closeBtn?.addEventListener('click', () => {
      modal?.classList.remove('flex');
      modal?.classList.add('hidden');
    });
    
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('flex');
        modal.classList.add('hidden');
      }
    });
    
    const clearBtn = document.getElementById('clear-cart-btn');
    clearBtn?.addEventListener('click', () => {
      if (confirm('¿Estás seguro de que quieres vaciar el carrito?')) {
        clearCart();
      }
    });
    
    const sendBtn = document.getElementById('send-whatsapp-btn');
    sendBtn?.addEventListener('click', () => {
      setTimeout(() => {
        modal?.classList.remove('flex');
        modal?.classList.add('hidden');
      }, 500);
    });
  });
</script>
